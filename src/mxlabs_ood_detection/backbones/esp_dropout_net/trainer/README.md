Most of this part is taken from the original code (https://github.com/sacmehta/ESPNet) and slightly modified to make it
work on newer PyTorch (1.7+) and PyTorchLightning.